#!/bin/bash

export KALDI_ROOT=${PREFIX}lib/kaldi
MAKE_ARGS=-j8

# Swap mirror with local one
sed -i"" -e 's/http:\/\/archive.ubuntu.com\/ubuntu\//http:\/\/mirror.optus.net\/ubuntu\//g' /etc/apt/sources.list

mkdir -p /var/log/speakeasy

apt-get update
apt-get install -y curl build-essential supervisor make python-setuptools python-dev python-yaml python-anyjson python-gi libgstreamer1.0-dev gstreamer1.0-plugins-good gstreamer1.0-tools gstreamer1.0-pulseaudio automake libtool autoconf wget git subversion libatlas3-base
easy_install pip
pip install ws4py==0.3.2 tornado==4.2.1

cd $KALDI_ROOT/tools
make ${MAKE_ARGS}

cd $KALDI_ROOT/src
./configure --shared
make depend ${MAKE_ARGS}
make ${MAKE_ARGS}
make ext ${MAKE_ARGS}

cd /usr/src
wget -O - http://www.digip.org/jansson/releases/jansson-2.7.tar.bz2 | tar -jx
cd jansson-2.7
./configure --prefix /usr
make ${MAKE_ARGS}
make check ${MAKE_ARGS}
make install ${MAKE_ARGS}

cd ${PREFIX}lib/gst-kaldi-nnet2-online/src
make depend ${MAKE_ARGS}
make ${MAKE_ARGS}

cd ${PREFIX}lib/kaldi-gstreamer-server/test/models
./download-tedlium-nnet2.sh